# 第五阶段门店管理员 - 基础信息 + 服务与用品管理接口文档

## 一、项目概述

本文档描述了宠物服务管理系统第五阶段的开发成果：门店管理员端的基础信息管理和服务与用品管理功能。系统实现了管理员身份验证、数据权限控制，支持城市、门店、员工、美容服务、宠物用品等全方位管理。

## 二、技术栈

- **框架**: Spring Boot 3.1.2
- **ORM**: MyBatis-Plus 3.5.3.2
- **数据库**: MySQL 8.0
- **JDK**: 17
- **API文档**: Knife4j 4.4.0
- **验证框架**: Jakarta Bean Validation

## 三、核心功能

### 3.1 管理员身份验证机制

**设计说明**：
- 前端传递 `userName`（用户名）或 `phone`（手机号）
- 后端通过 `User.UserName = Employee.EmpName` OR `User.Phone = Employee.EmpPhone` 验证管理员身份
- 验证通过后获取 `Employee.StoreID` 作为管理员所属门店ID
- 所有管理员接口自动添加门店权限过滤，仅能操作本门店数据

**实现类**：`AdminAuthUtil.java`

**验证方法**：
```java
// 验证管理员身份并返回员工信息
EmployeeDO validateAdmin(String userName, String phone)

// 获取管理员所属门店ID
Integer getAdminStoreId(String userName, String phone)
```

**使用方式**：
所有管理员接口都需要传递 `userName` 或 `phone` 参数进行身份验证。



## 四、API接口设计

### 4.1 城市管理

#### 4.1.1 查询所有城市
- **路径**: `GET /api/admin/cities`
- **参数**: `userName` 或 `phone`（管理员身份验证）
- **响应示例**:
```json
{
  "code": 200,
  "message": "操作成功",
  "data": [
    {
      "cityId": 1,
      "province": "北京市",
      "cityName": "北京",
      "zipCode": "100000"
    }
  ]
}
```

#### 4.1.2 创建城市
- **路径**: `POST /api/admin/cities`
- **参数**: `userName` 或 `phone`
- **请求体**:
```json
{
  "province": "北京市",
  "cityName": "北京",
  "zipCode": "100000"
}
```

#### 4.1.3 更新城市
- **路径**: `PUT /api/admin/cities/{cityId}`
- **参数**: `userName` 或 `phone`

#### 4.1.4 删除城市
- **路径**: `DELETE /api/admin/cities/{cityId}`
- **参数**: `userName` 或 `phone`

**业务规则**：
- 城市名+省份必须唯一
- 删除前需检查是否有门店关联



### 4.2 员工管理

#### 4.2.1 分页查询门店员工列表
- **路径**: `GET /api/admin/employees`
- **参数**: 
  - `userName` 或 `phone`（管理员身份验证）
  - `pageNum`（页码，默认1）
  - `pageSize`（每页大小，默认10）
- **响应示例**:
```json
{
  "code": 200,
  "message": "操作成功",
  "data": {
    "total": 10,
    "list": [
      {
        "empId": 1,
        "storeId": 1,
        "empName": "李四",
        "position": "BEAUTICIAN",
        "empPhone": "13800138001",
        "entryTime": "2022-01-01",
        "salary": 5000.00
      }
    ],
    "pageNum": 1,
    "pageSize": 10
  }
}
```

#### 4.2.2 创建员工
- **路径**: `POST /api/admin/employees`
- **参数**: `userName` 或 `phone`
- **请求体**:
```json
{
  "empName": "李四",
  "position": "BEAUTICIAN",
  "empPhone": "13800138001",
  "entryTime": "2022-01-01",
  "salary": 5000.00
}
```

**业务规则**：
- 员工手机号必须唯一
- Position支持：DOCTOR（医生）、BEAUTICIAN（美容师）、ADMIN（管理员）
- 自动关联当前管理员所属门店ID



### 4.3 美容服务管理

#### 4.3.1 分页查询美容服务列表
- **路径**: `GET /api/admin/beauty`
- **参数**: `userName` 或 `phone`、`pageNum`、`pageSize`

#### 4.3.2 创建美容服务
- **路径**: `POST /api/admin/beauty`
- **请求体**:
```json
{
  "beautyName": "全身清洁",
  "beautyType": "美容",
  "price": 80.00,
  "duration": 60,
  "beautyRemarks": "包含洗澡、吹干、梳理毛发"
}
```

#### 4.3.3 更新美容服务
- **路径**: `PUT /api/admin/beauty/{beautyId}`
- **说明**: 价格调整仅影响新订单，历史订单按原价格结算

#### 4.3.4 删除美容服务
- **路径**: `DELETE /api/admin/beauty/{beautyId}`

### 4.4 宠物用品管理

#### 4.4.1 分页查询用品列表
- **路径**: `GET /api/admin/products`
- **参数**: `userName` 或 `phone`、`pageNum`、`pageSize`

#### 4.4.2 创建用品
- **路径**: `POST /api/admin/products`
- **请求体**:
```json
{
  "productName": "狗粮",
  "productType": "食品",
  "supplier": "XX宠物用品公司"
}
```

**业务规则**：
- 用品不可删除，仅可下架
- 用品信息全局共享，不区分门店



### 4.5 门店铺货管理

#### 4.5.1 分页查询门店铺货列表
- **路径**: `GET /api/admin/product-store`
- **参数**: `userName` 或 `phone`、`pageNum`、`pageSize`
- **说明**: 自动过滤当前管理员所属门店的铺货记录

#### 4.5.2 创建或更新门店铺货
- **路径**: `POST /api/admin/product-store`
- **请求体**:
```json
{
  "productId": 1,
  "price": 180.00,
  "storeStock": 100,
  "shelfStatus": "在售"
}
```
- **说明**: 
  - 如果该用品已在本门店铺货，则更新价格和库存
  - 如果该用品未在本门店铺货，则创建新铺货记录
  - 自动关联当前管理员所属门店ID

#### 4.5.3 调整库存
- **路径**: `PUT /api/admin/product-store/{relId}/stock`
- **请求体**:
```json
{
  "adjustmentType": "ADD",
  "quantity": 10
}
```
- **调整类型**:
  - `ADD`: 补货（库存增加）
  - `REDUCE`: 减库存（库存减少）

**业务规则**：
- 库存为0时自动更新上架状态为"缺货"
- 库存≥1时自动更新上架状态为"在售"
- 减库存时不能超过当前库存数量
- 仅能调整本门店的库存



## 五、测试步骤

### 5.1 环境准备

1. 确保MySQL数据库已安装并启动
2. 确保数据库中已有测试数据：
   - 至少1个用户（user表）
   - 至少1个员工（employee表），且员工姓名或手机号与用户匹配
   - 至少1个门店（store表）
   - 至少1个城市（city表）
3. 启动项目：`mvn spring-boot:run`
4. 访问API文档：http://localhost:8082/doc.html

### 5.2 准备测试数据

**创建管理员账户**：
需要在数据库中创建一个用户，并创建一个与该用户姓名或手机号匹配的员工记录。

```sql
-- 插入测试用户
INSERT INTO user (UserName, Phone, Address, Email) 
VALUES ('张三', '13800138000', '北京市朝阳区', 'zhangsan@example.com');

-- 插入测试员工（与用户匹配）
INSERT INTO employee (StoreID, EmpName, Position, EmpPhone, EntryTime, Salary) 
VALUES (1, '张三', 'ADMIN', '13800138000', '2022-01-01', 8000.00);

-- 插入测试城市
INSERT INTO city (Province, CityName, ZipCode) 
VALUES ('北京市', '北京', '100000');

-- 插入测试门店
INSERT INTO store (CityID, StoreName, StoreAddress, StorePhone, BusinessHours) 
VALUES (1, '宠物乐园总店', '朝阳区建国路88号', '010-12345678', '09:00-21:00');

-- 插入测试用品
INSERT INTO petProduct (ProductName, ProductType, Supplier) 
VALUES ('狗粮', '食品', 'XX宠物用品公司');
```



### 5.3 测试场景

#### 场景1：管理员身份验证测试

1. 打开Knife4j文档界面：http://localhost:8082/doc.html
2. 找到"管理员-城市管理"分组下的"查询所有城市"接口
3. 填写参数：
   - `userName`: 张三（或留空）
   - `phone`: 13800138000（或留空）
4. 点击"执行"
5. **预期结果**：返回城市列表，code=200
6. **失败测试**：使用不存在的用户名或手机号
7. **预期结果**：返回"用户不存在"或"该用户不是管理员"错误

#### 场景2：城市管理测试

**2.1 创建城市**
1. 找到"创建城市"接口
2. 填写参数：
   - `userName`: 张三
   - `phone`: 13800138000
3. 填写请求体：
```json
{
  "province": "上海市",
  "cityName": "上海",
  "zipCode": "200000"
}
```
4. 点击"执行"
5. **预期结果**：返回城市ID，code=200

**2.2 唯一性校验测试**
1. 再次创建相同的城市（省份+城市名相同）
2. **预期结果**：返回"该省份下已存在同名城市"错误

**2.3 更新城市**
1. 找到"更新城市"接口
2. 输入cityId=1
3. 修改邮政编码
4. **预期结果**：更新成功

**2.4 删除城市**
1. 找到"删除城市"接口
2. 输入cityId=2（确保没有门店关联）
3. **预期结果**：删除成功



#### 场景3：员工管理测试

**3.1 查询门店员工列表**
1. 找到"分页查询门店员工列表"接口
2. 填写参数：
   - `userName`: 张三
   - `pageNum`: 1
   - `pageSize`: 10
3. **预期结果**：返回当前管理员所属门店的员工列表

**3.2 创建员工**
1. 找到"创建员工"接口
2. 填写请求体：
```json
{
  "empName": "李四",
  "position": "BEAUTICIAN",
  "empPhone": "13800138001",
  "entryTime": "2023-01-01",
  "salary": 5000.00
}
```
3. **预期结果**：返回员工ID，员工自动关联到管理员所属门店

**3.3 手机号唯一性测试**
1. 再次创建手机号相同的员工
2. **预期结果**：返回"该手机号已被使用"错误

**3.4 更新员工**
1. 找到"更新员工"接口
2. 修改员工薪资
3. **预期结果**：更新成功

**3.5 权限测试**
1. 尝试更新其他门店的员工
2. **预期结果**：返回"无权限修改其他门店员工信息"错误



#### 场景4：美容服务管理测试

**4.1 查询美容服务列表**
1. 找到"分页查询美容服务列表"接口
2. 填写参数：`userName`: 张三
3. **预期结果**：返回美容服务列表

**4.2 创建美容服务**
1. 找到"创建美容服务"接口
2. 填写请求体：
```json
{
  "beautyName": "全身清洁",
  "beautyType": "美容",
  "price": 80.00,
  "duration": 60,
  "beautyRemarks": "包含洗澡、吹干、梳理毛发"
}
```
3. **预期结果**：返回美容服务ID

**4.3 更新美容服务价格**
1. 找到"更新美容服务"接口
2. 修改价格为100.00
3. **预期结果**：更新成功
4. **注意**：价格调整仅影响新订单

**4.4 删除美容服务**
1. 找到"删除美容服务"接口
2. 输入beautyId
3. **预期结果**：删除成功



#### 场景5：宠物用品管理测试

**5.1 查询用品列表**
1. 找到"分页查询用品列表"接口
2. 填写参数：`userName`: 张三
3. **预期结果**：返回用品列表

**5.2 创建用品**
1. 找到"创建用品"接口
2. 填写请求体：
```json
{
  "productName": "猫粮",
  "productType": "食品",
  "supplier": "YY宠物用品公司"
}
```
3. **预期结果**：返回用品ID

**5.3 更新用品**
1. 找到"更新用品"接口
2. 修改供应商信息
3. **预期结果**：更新成功

#### 场景6：门店铺货管理测试

**6.1 查询门店铺货列表**
1. 找到"分页查询门店铺货列表"接口
2. 填写参数：`userName`: 张三
3. **预期结果**：返回当前门店的铺货列表

**6.2 创建门店铺货**
1. 找到"创建或更新门店铺货"接口
2. 填写请求体：
```json
{
  "productId": 1,
  "price": 180.00,
  "storeStock": 100,
  "shelfStatus": "在售"
}
```
3. **预期结果**：返回关联ID，铺货记录自动关联到管理员所属门店

**6.3 更新门店铺货**
1. 再次调用"创建或更新门店铺货"接口
2. 使用相同的productId，修改价格和库存
3. **预期结果**：更新成功（不会创建重复记录）



**6.4 库存调整测试 - 补货**
1. 找到"调整库存"接口
2. 输入relId（铺货记录ID）
3. 填写请求体：
```json
{
  "adjustmentType": "ADD",
  "quantity": 50
}
```
4. **预期结果**：库存增加50，上架状态为"在售"

**6.5 库存调整测试 - 减库存**
1. 填写请求体：
```json
{
  "adjustmentType": "REDUCE",
  "quantity": 30
}
```
2. **预期结果**：库存减少30

**6.6 库存为0测试**
1. 减库存至0
2. **预期结果**：库存为0，上架状态自动变为"缺货"

**6.7 库存不足测试**
1. 尝试减库存超过当前库存
2. **预期结果**：返回"库存不足，无法减少"错误

**6.8 权限测试**
1. 尝试调整其他门店的库存
2. **预期结果**：返回"无权限调整其他门店的库存"错误



## 六、错误码说明

| 错误码 | 错误信息 | 说明 |
|--------|----------|------|
| 200 | 操作成功 | 请求成功 |
| 400 | 用户名或手机号不能为空 | 管理员身份验证参数缺失 |
| 400 | 用户不存在 | 用户名或手机号不存在 |
| 400 | 该用户不是管理员 | 用户未关联员工记录 |
| 400 | 该省份下已存在同名城市 | 城市唯一性校验失败 |
| 400 | 该手机号已被使用 | 员工手机号唯一性校验失败 |
| 400 | 无权限修改其他门店员工信息 | 数据权限校验失败 |
| 400 | 无权限调整其他门店的库存 | 数据权限校验失败 |
| 400 | 库存不足，无法减少 | 库存调整失败 |
| 400 | 城市不存在 | 城市ID无效 |
| 400 | 员工不存在 | 员工ID无效 |
| 400 | 美容服务不存在 | 美容服务ID无效 |
| 400 | 用品不存在 | 用品ID无效 |
| 400 | 铺货记录不存在 | 铺货记录ID无效 |
| 500 | 系统错误 | 服务器内部错误 |

## 七、注意事项

1. **管理员身份验证**：所有管理员接口都需要传递 `userName` 或 `phone` 参数
2. **数据权限**：管理员只能操作本门店的数据（员工、铺货、库存等）
3. **唯一性约束**：城市名+省份、员工手机号、门店电话等字段需保证唯一
4. **库存管理**：库存为0时自动更新为"缺货"，库存≥1时自动更新为"在售"
5. **价格调整**：美容服务价格调整仅影响新订单，历史订单按原价格结算
6. **门店铺货**：同一用品在同一门店只能有一条铺货记录，重复提交会更新现有记录



## 八、已实现功能清单

### 8.1 基础信息管理
- ? 管理员身份验证（AdminAuthUtil）
- ? 城市管理（CRUD）
- ? 员工管理（CRUD + 权限控制）
- ? 门店管理（查询功能，CRUD功能可扩展）

### 8.2 服务管理
- ? 美容服务管理（CRUD）
- ?? 医疗服务管理（未实现，可使用MedicalRecord表扩展）
- ?? 寄养服务管理（未实现，可使用FosterRecord表扩展）

### 8.3 用品管理
- ? 宠物用品管理（CRUD）
- ? 门店铺货管理（创建/更新）
- ? 库存调整（补货/减库存）

### 8.4 未实现功能（可扩展）
- ? 客户管理（模糊查询、冻结/注销）- 需扩展User表字段
- ? 请假管理（申请审批）- 需扩展LeaveRecord表字段
- ? 员工排班管理
- ? 操作日志记录 - 需创建OperationLog表

**说明**：由于不能修改数据库表结构的限制，部分功能（如客户冻结/注销、请假驳回原因、操作日志）未实现。这些功能需要扩展表字段才能完整实现。

## 九、代码结构

```
src/main/java/cn/edu/xaut/
├── controller/admin/          # 管理员Controller
│   ├── AdminCityController.java
│   ├── AdminEmployeeController.java
│   ├── AdminBeautyController.java
│   ├── AdminProductController.java
│   └── AdminProductStoreController.java
├── service/                   # Service层
│   ├── city/
│   ├── employee/
│   ├── beauty/
│   ├── petproduct/
│   └── petproductstore/
├── mapper/                    # Mapper层
│   ├── CityMapper.java
│   ├── EmployeeMapper.java
│   └── ...
├── domain/
│   ├── dto/admin/            # 管理员DTO
│   │   ├── CityDTO.java
│   │   ├── EmployeeDTO.java
│   │   ├── BeautyServiceDTO.java
│   │   ├── ProductDTO.java
│   │   ├── ProductStoreDTO.java
│   │   └── StockAdjustmentDTO.java
│   └── entity/               # 实体类
└── utils/
    └── AdminAuthUtil.java    # 管理员身份验证工具类
```



## 十、常见问题

### Q1：如何创建管理员账户？
A：需要在数据库中创建两条记录：
1. 在user表中创建用户记录
2. 在employee表中创建员工记录，确保员工的姓名或手机号与用户匹配

### Q2：为什么提示"该用户不是管理员"？
A：请检查：
- user表中是否存在该用户
- employee表中是否存在姓名或手机号与该用户匹配的员工记录

### Q3：为什么无法操作其他门店的数据？
A：系统实现了数据权限控制，管理员只能操作本门店的数据。这是通过AdminAuthUtil获取管理员所属门店ID实现的。

### Q4：如何实现门店铺货的"新增"和"修改"？
A：使用同一个接口 `POST /api/admin/product-store`：
- 如果该用品未在本门店铺货，则创建新记录
- 如果该用品已在本门店铺货，则更新现有记录

### Q5：库存调整后上架状态如何变化？
A：
- 库存为0时，自动更新为"缺货"
- 库存≥1且原状态为"缺货"时，自动更新为"在售"
- 其他情况保持原状态不变

### Q6：为什么部分功能未实现？
A：由于项目要求不能修改数据库表结构，部分功能（如客户冻结/注销、请假驳回原因、操作日志）需要扩展表字段才能实现，因此未包含在本阶段开发中。

## 十一、联系方式

如有问题或建议，请联系项目开发团队。

---

**文档版本**：v1.0  
**更新时间**：2025-12-18  
**编写人**：Kiro AI Assistant

