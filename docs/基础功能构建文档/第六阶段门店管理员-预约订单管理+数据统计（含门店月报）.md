# 第六阶段门店管理员 - 预约订单管理 + 数据统计（含门店月报）接口文档

## 一、项目概述

本文档描述了宠物服务管理系统第六阶段的开发成果：门店管理员端的预约审核、订单退款、专项服务管理和数据统计功能。系统实现了完整的预约审核流程、订单退款机制、三类专项服务管理（美容、寄养、医疗），以及基于数据库视图的门店月报查询功能。

## 二、技术栈

- **框架**: Spring Boot 3.1.2
- **ORM**: MyBatis-Plus 3.5.3.2
- **数据库**: MySQL 8.0
- **JDK**: 17
- **API文档**: Knife4j 4.4.0
- **验证框架**: Jakarta Bean Validation

## 三、核心功能

### 3.1 预约与订单管理

#### 3.1.1 查询待审核预约列表

**接口路径**：`GET /api/admin/appointments/pending`

**功能说明**：查询门店所有待审核的预约

**请求参数**：
- `userName`：管理员用户名（可选）
- `phone`：管理员手机号（可选）

**响应示例**：
```json
{
  "code": 200,
  "message": "操作成功",
  "data": [
    {
      "apptId": 1,
      "apptTime": "2025-12-25 10:00:00",
      "apptStatus": "待服务",
      "createTime": "2025-12-18 14:30:00",
      "petName": "旺旺",
      "userName": "张三",
      "userPhone": "138****5678"
    }
  ]
}
```

#### 3.1.2 审核预约

**接口路径**：`PUT /api/admin/appointments/{apptId}/review`

**功能说明**：审核预约（通过或驳回）

**请求参数**：
- `apptId`：预约ID（路径参数）
- `userName`：管理员用户名（可选）
- `phone`：管理员手机号（可选）

**请求体示例**：
```json
{
  "approved": true,
  "empId": 1,
  "rejectReason": null
}
```

**审核驳回示例**：
```json
{
  "approved": false,
  "empId": null,
  "rejectReason": "预约时间冲突，请重新预约"
}
```

**响应示例**：
```json
{
  "code": 200,
  "message": "操作成功",
  "data": null
}
```

**业务规则**：
1. 审核通过：保持预约状态为"待服务"，可选分配员工，自动生成订单
2. 审核驳回：更新预约状态为"已取消"，驳回原因通过接口返回（不存储到数据库）
3. 只能审核状态为"待服务"的预约
4. 只能审核本门店的预约

#### 3.1.3 查询门店订单列表

**接口路径**：`GET /api/admin/appointments/orders`

**功能说明**：查询门店所有订单

**请求参数**：
- `userName`：管理员用户名（可选）
- `phone`：管理员手机号（可选）
- `pageNum`：页码（默认1）
- `pageSize`：每页大小（默认10）

**响应示例**：
```json
{
  "code": 200,
  "message": "操作成功",
  "data": {
    "total": 50,
    "records": [
      {
        "orderId": 1,
        "apptId": 1,
        "totalAmount": 500.00,
        "payStatus": "已支付",
        "payMethod": "WECHAT",
        "payTime": "2025-12-18 14:30:00",
        "orderCreateTime": "2025-12-18 14:00:00",
        "userName": "张三",
        "userPhone": "138****5678",
        "petName": "旺旺"
      }
    ]
  }
}
```

#### 3.1.4 订单退款

**接口路径**：`PUT /api/admin/appointments/orders/{orderId}/refund`

**功能说明**：对已支付订单进行退款

**请求参数**：
- `orderId`：订单ID（路径参数）
- `userName`：管理员用户名（可选）
- `phone`：管理员手机号（可选）

**请求体示例**：
```json
{
  "refundReason": "客户要求退款"
}
```

**响应示例**：
```json
{
  "code": 200,
  "message": "操作成功",
  "data": null
}
```

**业务规则**：
1. 只能退款状态为"已支付"的订单
2. 服务已完成的订单不能退款
3. 退款后自动恢复用品库存
4. 退款后预约状态更新为"已取消"
5. 退款原因通过接口返回（不存储到数据库）


### 3.2 专项服务管理

#### 3.2.1 完成美容服务

**接口路径**：`PUT /api/admin/services/beauty/{apptId}/complete`

**功能说明**：标记美容服务为已完成

**请求参数**：
- `apptId`：预约ID（路径参数）
- `userName`：管理员用户名（可选）
- `phone`：管理员手机号（可选）

**响应示例**：
```json
{
  "code": 200,
  "message": "操作成功",
  "data": null
}
```

**业务规则**：
1. 只能完成状态为"待服务"的预约
2. 完成后预约状态更新为"已完成"
3. 只能操作本门店的预约

#### 3.2.2 更新寄养每日状态

**接口路径**：`PUT /api/admin/services/foster/{fosterId}/daily-status`

**功能说明**：更新寄养宠物的每日状态

**请求参数**：
- `fosterId`：寄养ID（路径参数）
- `userName`：管理员用户名（可选）
- `phone`：管理员手机号（可选）

**请求体示例**：
```json
{
  "dailyStatus": "2025-12-19：宠物状态良好，食欲正常，活动积极"
}
```

**响应示例**：
```json
{
  "code": 200,
  "message": "操作成功",
  "data": null
}
```

**业务规则**：
1. 只能更新状态为"进行中"的寄养记录
2. 新状态会追加到原有状态后（格式：原有内容\n新内容）
3. 只能操作本门店的寄养记录

#### 3.2.3 创建医疗记录

**接口路径**：`POST /api/admin/services/medical`

**功能说明**：为预约创建医疗记录

**请求参数**：
- `userName`：管理员用户名（可选）
- `phone`：管理员手机号（可选）

**请求体示例**：
```json
{
  "apptId": 1,
  "diagnosis": "感冒，轻度发烧",
  "medication": "阿莫西林 100mg，每日2次",
  "medicalFee": 120.00,
  "followUpAdvice": "注意保暖，3天后复诊"
}
```

**响应示例**：
```json
{
  "code": 200,
  "message": "操作成功",
  "data": 1
}
```

**业务规则**：
1. 每个预约只能创建一次医疗记录
2. 自动关联预约和医疗记录
3. 只能为本门店的预约创建医疗记录

#### 3.2.4 补充医疗记录备注

**接口路径**：`PUT /api/admin/services/medical/{medicalId}/remark`

**功能说明**：为已有医疗记录补充备注

**请求参数**：
- `medicalId`：医疗记录ID（路径参数）
- `remark`：备注内容
- `userName`：管理员用户名（可选）
- `phone`：管理员手机号（可选）

**响应示例**：
```json
{
  "code": 200,
  "message": "操作成功",
  "data": null
}
```

**业务规则**：
1. 备注会追加到复诊建议字段（格式：原有内容\n补充：新内容）
2. 只能操作本门店的医疗记录


### 3.3 数据统计（门店月报）

#### 3.3.1 查询门店月报

**接口路径**：`GET /api/admin/appointments/monthly-report`

**功能说明**：查询门店月度运营数据

**请求参数**：
- `userName`：管理员用户名（可选）
- `phone`：管理员手机号（可选）
- `statMonth`：统计月份（必填，格式：YYYY-MM）
- `pageNum`：页码（默认1）
- `pageSize`：每页大小（默认10）

**响应示例**：
```json
{
  "code": 200,
  "message": "操作成功",
  "data": {
    "total": 1,
    "records": [
      {
        "storeId": 1,
        "storeName": "宠物乐园总店",
        "statMonth": "2025-12",
        "newUserCount": 15,
        "totalOrderCount": 50,
        "beautyOrderCount": 20,
        "fosterOrderCount": 15,
        "medicalOrderCount": 15,
        "productSales": 5000.00,
        "beautyRevenue": 1600.00,
        "fosterRevenue": 7500.00,
        "medicalRevenue": 1800.00,
        "totalRevenue": 15900.00,
        "hotServiceType": "寄养"
      }
    ]
  }
}
```

**字段说明**：
- `newUserCount`：该月新增客户数（注册时间在该月且有订单）
- `totalOrderCount`：总订单数
- `beautyOrderCount`：美容服务订单数
- `fosterOrderCount`：寄养服务订单数
- `medicalOrderCount`：医疗服务订单数
- `productSales`：用品销售额
- `beautyRevenue`：美容营收
- `fosterRevenue`：寄养营收
- `medicalRevenue`：医疗营收
- `totalRevenue`：总营收（服务+用品）
- `hotServiceType`：热门服务类型（订单量最多的服务）

**业务规则**：
1. 基于数据库视图 `v_store_monthly_report` 查询
2. 只统计已支付订单
3. 自动过滤当前管理员所属门店数据
4. 无数据时返回空列表

## 四、数据库视图设计

### 4.1 门店月报视图

**视图名称**：`v_store_monthly_report`

**创建SQL**：见 `docs/门店月报视图.sql`

**视图说明**：
- 统计每个门店每月的运营数据
- 包含订单量、营收、新增客户等关键指标
- 自动计算热门服务类型
- 只统计已支付订单

## 五、简化方案说明

由于数据库表结构限制，以下功能采用简化方案：

### 5.1 预约审核驳回原因

**原需求**：存储驳回原因到 `Appointment.RejectReason` 字段

**简化方案**：
- 驳回时将预约状态设置为"已取消"
- 驳回原因通过接口返回消息告知，不存储到数据库
- 无法区分"用户取消"和"管理员驳回"

### 5.2 订单退款原因

**原需求**：存储退款原因到 `Order.RefundReason` 字段

**简化方案**：
- 使用现有的 `Order.PayStatus = '退款'` 状态
- 退款原因通过接口返回消息告知，不存储到数据库

### 5.3 美容服务结果

**原需求**：记录服务结果到 `ApptBeauty.ServiceResult` 字段

**简化方案**：
- 不记录服务结果字段
- 仅更新预约状态为"已完成"

### 5.4 寄养总结

**原需求**：存储寄养总结到 `FosterRecord.FosterSummary` 字段

**简化方案**：
- 使用现有的 `FosterRecord.DailyStatus` 字段追加总结内容
- 格式：日期：状态\n总结：xxx

### 5.5 医疗备注补充

**原需求**：存储医疗备注到 `MedicalRecord.MedicalRemark` 字段

**简化方案**：
- 使用现有的 `MedicalRecord.FollowUpAdvice` 字段追加备注内容
- 格式：原有内容\n补充：xxx


## 六、错误码说明

| 错误码 | 错误信息 | 说明 |
|--------|----------|------|
| 200 | 操作成功 | 请求成功 |
| 400 | 预约不存在 | 预约ID无效 |
| 400 | 无权限操作其他门店的预约 | 数据权限校验失败 |
| 400 | 预约状态不是'待服务'，无法审核 | 预约状态校验失败 |
| 400 | 驳回原因不能为空 | 参数校验失败 |
| 400 | 订单不存在 | 订单ID无效 |
| 400 | 订单状态不是'已支付'，无法退款 | 订单状态校验失败 |
| 400 | 服务已完成，无法退款 | 业务规则校验失败 |
| 400 | 寄养记录不存在 | 寄养ID无效 |
| 400 | 寄养状态不是'进行中'，无法更新 | 寄养状态校验失败 |
| 400 | 该预约已有医疗记录，无法重复创建 | 业务规则校验失败 |
| 400 | 医疗记录不存在 | 医疗记录ID无效 |
| 500 | 系统错误 | 服务器内部错误 |

## 七、测试步骤

### 7.1 环境准备

1. 确保MySQL数据库已安装并启动
2. 执行门店月报视图创建SQL：
```bash
mysql -u root -p pet_service_management < docs/门店月报视图.sql
```
3. 确保数据库中已有测试数据：
   - 至少1个管理员用户（user表 + employee表匹配）
   - 至少1个门店（store表）
   - 至少1个待审核预约（appointment表，状态为"待服务"）
   - 至少1个已支付订单（order表，状态为"已支付"）
4. 启动项目：`mvn spring-boot:run`
5. 访问API文档：http://localhost:8081/doc.html

### 7.2 测试数据准备

```sql
-- 插入测试管理员
INSERT INTO `user` (UserName, Phone, Address, Email) 
VALUES ('管理员张三', '13900000001', '北京市朝阳区', 'admin@example.com');

-- 插入测试员工（与管理员匹配）
INSERT INTO employee (StoreID, EmpName, Position, EmpPhone, EntryTime, Salary) 
VALUES (1, '管理员张三', 'ADMIN', '13900000001', '2022-01-01', 10000.00);

-- 插入测试预约（待审核）
INSERT INTO appointment (UserID, PetID, StoreID, ApptTime, ApptStatus, CreateTime)
VALUES (1, 1, 1, '2025-12-26 14:00:00', '待服务', NOW());

-- 插入测试订单（已支付）
INSERT INTO `order` (ApptID, TotalAmount, PayStatus, PayMethod, PayTime, OrderCreateTime)
VALUES (1, 500.00, '已支付', 'WECHAT', NOW(), NOW());
```

### 7.3 核心功能测试

#### 测试1：查询待审核预约列表

1. 打开Knife4j文档界面：http://localhost:8081/doc.html
2. 找到"管理员-预约订单管理"分组下的"查询待审核预约列表"接口
3. 填写参数：
   - `userName`: 管理员张三
   - `phone`: 13900000001
4. 点击"执行"
5. **预期结果**：返回待审核预约列表，code=200

#### 测试2：审核预约（通过）

1. 找到"审核预约"接口
2. 填写参数：
   - `apptId`: 1（使用测试数据中的预约ID）
   - `userName`: 管理员张三
3. 填写请求体：
```json
{
  "approved": true,
  "empId": 1,
  "rejectReason": null
}
```
4. 点击"执行"
5. **预期结果**：审核成功，code=200
6. **验证**：
   - 查询订单列表，应该有新生成的订单
   - 订单状态为"未支付"

#### 测试3：审核预约（驳回）

1. 创建一个新的待审核预约
2. 找到"审核预约"接口
3. 填写请求体：
```json
{
  "approved": false,
  "empId": null,
  "rejectReason": "预约时间冲突，请重新预约"
}
```
4. 点击"执行"
5. **预期结果**：审核成功，code=200
6. **验证**：
   - 查询预约详情，状态变为"已取消"
   - 不会生成订单

#### 测试4：查询门店订单列表

1. 找到"查询门店订单列表"接口
2. 填写参数：
   - `userName`: 管理员张三
   - `pageNum`: 1
   - `pageSize`: 10
3. 点击"执行"
4. **预期结果**：返回门店订单列表，code=200

#### 测试5：订单退款

1. 找到"订单退款"接口
2. 填写参数：
   - `orderId`: 1（使用已支付的订单ID）
   - `userName`: 管理员张三
3. 填写请求体：
```json
{
  "refundReason": "客户要求退款"
}
```
4. 点击"执行"
5. **预期结果**：退款成功，code=200
6. **验证**：
   - 查询订单详情，支付状态变为"退款"
   - 查询预约详情，状态变为"已取消"
   - 如果订单包含用品，库存应该恢复


#### 测试6：完成美容服务

1. 找到"管理员-专项服务管理"分组下的"完成美容服务"接口
2. 填写参数：
   - `apptId`: 1（使用待服务的预约ID）
   - `userName`: 管理员张三
3. 点击"执行"
4. **预期结果**：完成成功，code=200
5. **验证**：查询预约详情，状态变为"已完成"

#### 测试7：更新寄养每日状态

1. 找到"更新寄养每日状态"接口
2. 填写参数：
   - `fosterId`: 1（使用进行中的寄养ID）
   - `userName`: 管理员张三
3. 填写请求体：
```json
{
  "dailyStatus": "2025-12-19：宠物状态良好，食欲正常，活动积极"
}
```
4. 点击"执行"
5. **预期结果**：更新成功，code=200
6. **验证**：查询寄养详情，每日状态字段包含新内容

#### 测试8：创建医疗记录

1. 找到"创建医疗记录"接口
2. 填写参数：`userName`: 管理员张三
3. 填写请求体：
```json
{
  "apptId": 1,
  "diagnosis": "感冒，轻度发烧",
  "medication": "阿莫西林 100mg，每日2次",
  "medicalFee": 120.00,
  "followUpAdvice": "注意保暖，3天后复诊"
}
```
4. 点击"执行"
5. **预期结果**：创建成功，返回医疗记录ID，code=200
6. **验证**：查询预约详情，应该包含医疗服务信息

#### 测试9：补充医疗记录备注

1. 找到"补充医疗记录备注"接口
2. 填写参数：
   - `medicalId`: 1（使用测试8创建的医疗记录ID）
   - `remark`: "患者恢复良好，可以正常活动"
   - `userName`: 管理员张三
3. 点击"执行"
4. **预期结果**：补充成功，code=200
5. **验证**：查询医疗记录详情，复诊建议字段包含补充内容

#### 测试10：查询门店月报

1. 找到"查询门店月报"接口
2. 填写参数：
   - `userName`: 管理员张三
   - `statMonth`: 2025-12
   - `pageNum`: 1
   - `pageSize`: 10
3. 点击"执行"
4. **预期结果**：返回月报数据，code=200
5. **验证**：
   - 数据包含门店ID、门店名称、统计月份
   - 包含订单量、营收等统计数据
   - 热门服务类型正确

### 7.4 异常场景测试

#### 异常1：审核其他门店的预约

1. 使用门店A的管理员账号
2. 尝试审核门店B的预约
3. **预期结果**：返回"无权限操作其他门店的预约"错误

#### 异常2：重复审核预约

1. 审核一个预约（通过）
2. 再次审核同一个预约
3. **预期结果**：返回"预约状态不是'待服务'，无法审核"错误

#### 异常3：退款已完成服务的订单

1. 完成一个预约的服务
2. 尝试退款该预约的订单
3. **预期结果**：返回"服务已完成，无法退款"错误

#### 异常4：重复创建医疗记录

1. 为一个预约创建医疗记录
2. 再次为同一个预约创建医疗记录
3. **预期结果**：返回"该预约已有医疗记录，无法重复创建"错误

#### 异常5：更新已结束的寄养状态

1. 接领确认一个寄养记录（状态变为"已结束"）
2. 尝试更新该寄养的每日状态
3. **预期结果**：返回"寄养状态不是'进行中'，无法更新"错误

## 八、注意事项

1. **管理员身份验证**：所有管理员接口都需要传递 `userName` 或 `phone` 参数
2. **数据权限**：管理员只能操作本门店的数据
3. **事务控制**：所有涉及多表操作的接口都使用事务保证原子性
4. **简化方案**：由于数据库字段限制，部分信息（驳回原因、退款原因等）不存储到数据库
5. **门店月报**：基于数据库视图实现，需要先执行视图创建SQL
6. **库存恢复**：订单退款时自动恢复用品库存
7. **状态同步**：退款时预约状态同步更新为"已取消"

## 九、已实现功能清单

### 9.1 预约与订单管理
- ? 查询待审核预约列表
- ? 预约审核（通过/驳回）
- ? 查询门店订单列表（分页）
- ? 订单退款（含库存恢复）

### 9.2 专项服务管理
- ? 完成美容服务
- ? 更新寄养每日状态
- ? 创建医疗记录
- ? 补充医疗记录备注

### 9.3 数据统计
- ? 门店月报查询（基于视图）
- ? 多维度统计（订单量、营收、新增客户等）
- ? 热门服务类型统计

### 9.4 通用功能
- ? 统一异常处理
- ? 统一响应格式
- ? 数据权限控制
- ? 事务控制

## 十、代码结构

```
src/main/java/cn/edu/xaut/
├── controller/admin/
│   ├── AdminAppointmentController.java    # 预约订单管理
│   └── AdminServiceController.java        # 专项服务管理
├── service/admin/
│   ├── AdminAppointmentService.java
│   ├── AdminServiceManagementService.java
│   └── impl/
│       ├── AdminAppointmentServiceImpl.java
│       └── AdminServiceManagementServiceImpl.java
├── mapper/
│   └── AdminAppointmentMapper.java
├── domain/
│   ├── dto/admin/
│   │   ├── AppointmentReviewDTO.java
│   │   ├── OrderRefundDTO.java
│   │   ├── FosterDailyUpdateDTO.java
│   │   ├── MedicalRecordCreateDTO.java
│   │   └── StatisticsQueryDTO.java
│   └── vo/admin/
│       └── MonthlyReportVO.java
└── resources/mapper/
    └── AdminAppointmentMapper.xml

docs/
└── 门店月报视图.sql                      # 视图创建SQL
```

## 十一、常见问题

### Q1：为什么驳回原因不存储到数据库？
A：由于数据库表结构限制，`Appointment` 表没有 `RejectReason` 字段。采用简化方案，驳回原因通过接口返回消息告知，不永久存储。

### Q2：如何区分用户取消和管理员驳回？
A：当前简化方案无法区分。两种情况都将预约状态设置为"已取消"。如需区分，需要扩展数据库字段。

### Q3：退款后库存如何恢复？
A：系统自动查询订单包含的用品，调用 `increaseStock` 方法恢复库存。如果库存恢复后大于0且原状态为"缺货"，自动更新为"在售"。

### Q4：门店月报数据不准确怎么办？
A：请检查：
- 视图是否正确创建
- 订单支付状态是否为"已支付"
- 统计月份格式是否正确（YYYY-MM）

### Q5：如何测试门店月报功能？
A：需要先插入测试数据：
1. 创建已支付订单
2. 确保订单关联预约、服务、用品
3. 查询月报接口，传入正确的统计月份

## 十二、联系方式

如有问题或建议，请联系项目开发团队。

---

**文档版本**：v1.0  
**更新时间**：2025-12-18
