# 注册客户 - 预约管理 + 专项服务（美容 + 寄养 + 医疗）接口文档

## 一、项目概述

本文档描述了宠物服务管理系统第三阶段的开发成果：注册客户的预约管理和专项服务功能。系统支持客户提交多服务组合预约（美容、寄养、医疗），查询预约状态，取消预约，以及管理三类专项服务的全流程。

## 二、技术栈

- **框架**: Spring Boot 3.1.2
- **ORM**: MyBatis-Plus 3.5.3.2
- **数据库**: MySQL 8.0
- **JDK**: 17
- **API文档**: Knife4j 4.4.0
- **验证框架**: Jakarta Bean Validation

## 三、核心功能

### 3.1 预约管理

#### 3.1.1 提交多服务组合预约

**接口路径**：`POST /api/appointments`

**功能说明**：客户可以一次性预约美容、寄养、医疗等多种服务的任意组合

**请求体示例**：
```json
{
  "petId": 1,
  "storeId": 2,
  "apptTime": "2025-12-25 10:00:00",
  "empId": 3,
  "beautyIds": [1, 3],
  "fosterParam": {
    "startDate": "2025-12-25",
    "endDate": "2025-12-30",
    "fosterRemarks": "每日喂食2次"
  },
  "medicalParam": {
    "symptom": "咳嗽、精神差"
  }
}
```

**响应示例**：
```json
{
  "code": 200,
  "message": "操作成功",
  "data": 1
}
```

**业务规则**：
1. 预约时间必须在门店营业时间内
2. 如果分配了员工，员工在预约时间段内不能请假
3. 寄养服务的结束日期必须晚于开始日期
4. 医疗服务必须填写症状描述
5. 预约创建成功后，状态默认为"待服务"
6. 寄养服务创建后，状态默认为"进行中"
7. 所有操作在单个事务中执行，确保原子性

#### 3.1.2 查询用户的预约列表

**接口路径**：`GET /api/appointments/user/{userId}`

**功能说明**：查询指定用户所有宠物的预约记录

**响应示例**：
```json
{
  "code": 200,
  "message": "操作成功",
  "data": [
    {
      "apptId": 1,
      "petId": 1,
      "petName": "旺旺",
      "storeId": 2,
      "storeName": "宠物乐园总店",
      "apptTime": "2025-12-25 10:00:00",
      "apptStatus": "待服务",
      "empName": "李美容师",
      "createTime": "2025-12-18 14:30:00"
    }
  ]
}
```

#### 3.1.3 查询预约详情

**接口路径**：`GET /api/appointments/{apptId}`

**功能说明**：查询预约的详细信息，包含所有关联的服务明细

**响应示例**：
```json
{
  "code": 200,
  "message": "操作成功",
  "data": {
    "apptId": 1,
    "petId": 1,
    "petName": "旺旺",
    "storeId": 2,
    "storeName": "宠物乐园总店",
    "storeAddress": "朝阳区建国路88号",
    "storePhone": "010-12345678",
    "apptTime": "2025-12-25 10:00:00",
    "apptStatus": "待服务",
    "empName": "李美容师",
    "empPosition": "美容师",
    "createTime": "2025-12-18 14:30:00",
    "beautyServices": [
      {
        "beautyId": 1,
        "beautyName": "全身清洁",
        "beautyType": "美容",
        "price": 80.00,
        "duration": 60,
        "beautyRemarks": "包含洗澡、吹干、梳理毛发"
      }
    ],
    "fosterService": {
      "fosterId": 1,
      "startDate": "2025-12-25",
      "endDate": "2025-12-30",
      "fosterFee": 500.00,
      "fosterStatus": "进行中",
      "fosterRemarks": "每日喂食2次",
      "dailyStatus": null
    },
    "medicalService": {
      "medicalId": 1,
      "medicalTime": "2025-12-25 10:00:00",
      "diagnosis": "待诊断：咳嗽、精神差",
      "medication": null,
      "medicalFee": 0.00,
      "followUpAdvice": null
    }
  }
}
```

#### 3.1.4 取消预约

**接口路径**：`PUT /api/appointments/{apptId}/cancel`

**功能说明**：取消指定的预约

**响应示例**：
```json
{
  "code": 200,
  "message": "操作成功",
  "data": null
}
```

**业务规则**：
1. 只能取消状态为"待服务"的预约
2. 距离预约时间必须大于等于24小时
3. 取消成功后，预约状态更新为"已取消"
4. 如果预约包含寄养服务，寄养状态同步更新为"已取消"

**错误示例**：
```json
{
  "code": 400,
  "message": "距离服务时间不足24小时，无法取消",
  "data": null
}
```

### 3.2 美容服务管理

#### 3.2.1 查询用户的美容服务列表

**接口路径**：`GET /api/beauty-services/user/{userId}`

**功能说明**：查询指定用户所有宠物的美容服务记录

**响应示例**：
```json
{
  "code": 200,
  "message": "操作成功",
  "data": [
    {
      "apptId": 1,
      "petId": 1,
      "petName": "旺旺",
      "apptTime": "2025-12-25 10:00:00",
      "apptStatus": "待服务",
      "storeName": "宠物乐园总店",
      "beautyNames": ["全身清洁", "造型修剪"],
      "totalPrice": 230.00
    }
  ]
}
```

#### 3.2.2 查询美容服务详情

**接口路径**：`GET /api/beauty-services/{apptId}`

**功能说明**：查询指定预约的美容服务详细信息

**响应示例**：
```json
{
  "code": 200,
  "message": "操作成功",
  "data": {
    "apptId": 1,
    "petId": 1,
    "petName": "旺旺",
    "apptTime": "2025-12-25 10:00:00",
    "apptStatus": "待服务",
    "storeName": "宠物乐园总店",
    "storeAddress": "朝阳区建国路88号",
    "empName": "李美容师",
    "beautyDetails": [
      {
        "beautyId": 1,
        "beautyName": "全身清洁",
        "beautyType": "美容",
        "price": 80.00,
        "duration": 60,
        "beautyRemarks": "包含洗澡、吹干、梳理毛发"
      }
    ]
  }
}
```

### 3.3 寄养服务管理

#### 3.3.1 查询用户的寄养服务列表

**接口路径**：`GET /api/foster-services/user/{userId}`

**功能说明**：查询指定用户所有宠物的寄养服务记录

**响应示例**：
```json
{
  "code": 200,
  "message": "操作成功",
  "data": [
    {
      "fosterId": 1,
      "apptId": 1,
      "petId": 1,
      "petName": "旺旺",
      "startDate": "2025-12-25",
      "endDate": "2025-12-30",
      "fosterFee": 500.00,
      "fosterStatus": "进行中",
      "storeName": "宠物乐园总店"
    }
  ]
}
```

#### 3.3.2 查询寄养服务详情

**接口路径**：`GET /api/foster-services/{fosterId}`

**功能说明**：查询指定寄养记录的详细信息

**响应示例**：
```json
{
  "code": 200,
  "message": "操作成功",
  "data": {
    "fosterId": 1,
    "apptId": 1,
    "petId": 1,
    "petName": "旺旺",
    "startDate": "2025-12-25",
    "endDate": "2025-12-30",
    "fosterFee": 500.00,
    "fosterStatus": "进行中",
    "fosterRemarks": "每日喂食2次",
    "dailyStatus": "2025-12-26：状态良好，食欲正常",
    "storeName": "宠物乐园总店",
    "storeAddress": "朝阳区建国路88号",
    "empName": "王饲养员"
  }
}
```

#### 3.3.3 接领确认

**接口路径**：`PUT /api/foster-services/{fosterId}/pickup`

**功能说明**：确认接领宠物，结束寄养服务

**响应示例**：
```json
{
  "code": 200,
  "message": "操作成功",
  "data": null
}
```

**业务规则**：
1. 只能接领状态为"进行中"的寄养服务
2. 接领成功后，寄养状态更新为"已结束"
3. 关联的预约状态同步更新为"已完成"

### 3.4 医疗服务管理

#### 3.4.1 查询用户的医疗服务列表

**接口路径**：`GET /api/medical-services/user/{userId}`

**功能说明**：查询指定用户所有宠物的医疗服务记录

**响应示例**：
```json
{
  "code": 200,
  "message": "操作成功",
  "data": [
    {
      "medicalId": 1,
      "apptId": 1,
      "petId": 1,
      "petName": "旺旺",
      "medicalTime": "2025-12-25 10:00:00",
      "diagnosis": "感冒",
      "medicalFee": 120.00,
      "empName": "张医生",
      "storeName": "宠物乐园总店"
    }
  ]
}
```

#### 3.4.2 查询医疗服务详情

**接口路径**：`GET /api/medical-services/{medicalId}`

**功能说明**：查询指定医疗记录的详细信息

**响应示例**：
```json
{
  "code": 200,
  "message": "操作成功",
  "data": {
    "medicalId": 1,
    "apptId": 1,
    "petId": 1,
    "petName": "旺旺",
    "medicalTime": "2025-12-25 10:00:00",
    "diagnosis": "感冒",
    "medication": "阿莫西林 100mg，每日2次",
    "medicalFee": 120.00,
    "followUpAdvice": "注意保暖，3天后复诊",
    "empName": "张医生",
    "empPosition": "医生",
    "storeName": "宠物乐园总店",
    "storeAddress": "朝阳区建国路88号"
  }
}
```

## 四、数据安全

### 4.1 时间校验

系统统一使用服务器时间（`System.currentTimeMillis()`）进行所有时间相关的校验和计算，避免客户端时间偏差导致的业务错误。

### 4.2 事务控制

所有涉及多表操作的接口都使用`@Transactional`注解保证原子性，确保要么全部成功，要么全部回滚。

### 4.3 数据权限

系统确保用户只能访问和操作自己宠物的数据，通过UserID进行权限过滤。

## 五、错误码说明

| 错误码 | 错误信息 | 说明 |
|--------|----------|------|
| 200 | 操作成功 | 请求成功 |
| 400 | 预约时间不在门店营业时间内 | 预约时间校验失败 |
| 400 | 该员工在预约时间段内已请假 | 员工排班校验失败 |
| 400 | 寄养结束日期必须晚于开始日期 | 寄养日期校验失败 |
| 400 | 症状描述不能为空 | 医疗参数校验失败 |
| 400 | 距离服务时间不足24小时，无法取消 | 取消时间限制 |
| 400 | 预约状态不是'待服务'，无法取消 | 预约状态校验失败 |
| 400 | 寄养状态不是'进行中'，无法接领 | 寄养状态校验失败 |
| 400 | 宠物不存在 | 宠物ID无效 |
| 400 | 门店不存在 | 门店ID无效 |
| 400 | 预约不存在 | 预约ID无效 |
| 500 | 系统错误 | 服务器内部错误 |

## 六、测试步骤

### 6.1 环境准备

1. 确保MySQL数据库已安装并启动
2. 确保数据库中已有测试数据：
   - 至少1个用户（user表）
   - 至少1个宠物（pet表）
   - 至少1个门店（store表，包含营业时间）
   - 至少1个员工（employee表）
   - 至少1个美容项目（beauty表）
3. 启动项目：`mvn spring-boot:run`
4. 访问API文档：http://localhost:8081/doc.html

### 6.2 测试场景

#### 场景1：提交单服务预约（美容）

1. 打开Knife4j文档界面
2. 找到"预约管理"分组下的"提交多服务组合预约"接口
3. 填写请求参数：
```json
{
  "petId": 1,
  "storeId": 1,
  "apptTime": "2025-12-26 14:00:00",
  "beautyIds": [1]
}
```
4. 点击"执行"，查看响应
5. 预期结果：返回预约ID，code=200

#### 场景2：提交多服务组合预约（美容+寄养+医疗）

1. 填写请求参数：
```json
{
  "petId": 1,
  "storeId": 1,
  "apptTime": "2025-12-27 10:00:00",
  "empId": 1,
  "beautyIds": [1, 2],
  "fosterParam": {
    "startDate": "2025-12-27",
    "endDate": "2025-12-30",
    "fosterRemarks": "每日喂食2次"
  },
  "medicalParam": {
    "symptom": "咳嗽、精神差"
  }
}
```
2. 点击"执行"
3. 预期结果：返回预约ID，code=200
4. 验证：查询预约详情，确认包含所有三类服务

#### 场景3：查询预约列表

1. 找到"查询用户的预约列表"接口
2. 输入userId=1
3. 点击"执行"
4. 预期结果：返回该用户所有预约记录

#### 场景4：查询预约详情

1. 找到"查询预约详情"接口
2. 输入apptId（使用场景2创建的预约ID）
3. 点击"执行"
4. 预期结果：返回完整的预约信息，包含美容、寄养、医疗三类服务明细

#### 场景5：取消预约（成功）

1. 创建一个预约时间在48小时后的预约
2. 找到"取消预约"接口
3. 输入apptId
4. 点击"执行"
5. 预期结果：取消成功，code=200
6. 验证：查询预约详情，状态变为"已取消"

#### 场景6：取消预约（失败 - 24小时限制）

1. 创建一个预约时间在12小时后的预约
2. 尝试取消该预约
3. 预期结果：取消失败，返回"距离服务时间不足24小时，无法取消"

#### 场景7：查询美容服务列表

1. 找到"美容服务管理"分组下的"查询用户的美容服务列表"接口
2. 输入userId=1
3. 点击"执行"
4. 预期结果：返回该用户所有包含美容服务的预约

#### 场景8：查询寄养服务列表

1. 找到"寄养服务管理"分组下的"查询用户的寄养服务列表"接口
2. 输入userId=1
3. 点击"执行"
4. 预期结果：返回该用户所有寄养记录

#### 场景9：接领确认

1. 找到"接领确认"接口
2. 输入fosterId（使用场景2创建的寄养ID）
3. 点击"执行"
4. 预期结果：接领成功，code=200
5. 验证：查询寄养详情，状态变为"已结束"；查询预约详情，状态变为"已完成"

#### 场景10：查询医疗服务列表

1. 找到"医疗服务管理"分组下的"查询用户的医疗服务列表"接口
2. 输入userId=1
3. 点击"执行"
4. 预期结果：返回该用户所有医疗记录

### 6.3 异常场景测试

#### 测试1：预约时间不在营业时间内

1. 提交预约，apptTime设置为门店营业时间之外（如凌晨2点）
2. 预期结果：返回"预约时间不在门店营业时间内"

#### 测试2：寄养日期无效

1. 提交预约，fosterParam的endDate早于startDate
2. 预期结果：返回"寄养结束日期必须晚于开始日期"

#### 测试3：医疗症状为空

1. 提交预约，medicalParam的symptom为空字符串
2. 预期结果：返回"症状描述不能为空"

#### 测试4：取消已完成的预约

1. 尝试取消状态为"已完成"的预约
2. 预期结果：返回"预约状态不是'待服务'，无法取消"

#### 测试5：接领已结束的寄养

1. 尝试接领状态为"已结束"的寄养
2. 预期结果：返回"寄养状态不是'进行中'，无法接领"

## 七、注意事项

1. **时间格式**：所有时间字段使用ISO 8601格式，时区为GMT+8
2. **事务回滚**：如果预约创建过程中任何步骤失败，所有数据库更改都会回滚
3. **数据一致性**：取消预约或接领确认时，相关联的记录状态会自动同步更新
4. **权限控制**：用户只能查询和操作自己宠物的数据
5. **营业时间**：门店营业时间格式为"HH:mm-HH:mm"，如"09:00-21:00"
6. **寄养费用**：当前按每天100元计算，实际项目中应根据业务规则调整
7. **医疗记录**：预约创建时医疗记录为初始状态，诊断结果等由管理员后续完善

## 八、常见问题

### Q1：为什么预约创建失败？
A：请检查以下几点：
- 预约时间是否在门店营业时间内
- 如果分配了员工，员工是否在请假
- 寄养服务的日期是否有效
- 医疗服务是否填写了症状描述

### Q2：为什么无法取消预约？
A：取消预约需要满足两个条件：
- 预约状态必须是"待服务"
- 距离预约时间必须大于等于24小时

### Q3：如何查看预约包含哪些服务？
A：调用"查询预约详情"接口，响应中会包含beautyServices、fosterService、medicalService三个字段，分别对应三类服务的明细。

### Q4：寄养费用如何计算？
A：当前系统按照寄养天数×100元计算，天数=结束日期-开始日期。

### Q5：医疗记录的诊断结果何时填写？
A：预约创建时医疗记录为初始状态，诊断结果、用药情况等由管理员在实际就诊后填写。

## 九、联系方式

如有问题或建议，请联系项目开发团队。

---

**文档版本**：v1.0  
**更新时间**：2025-12-18  
**编写人**：Kiro AI Assistant
