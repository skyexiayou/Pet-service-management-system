# 用户认证功能测试指南

## 前置条件

### 1. 执行数据库迁移脚本

在测试之前，需要先执行数据库迁移脚本，为user表添加认证相关字段：

```sql
-- 执行 docs/用户认证字段补充.sql 中的SQL语句
```

**重要提示：** 如果你的user表中已有数据，脚本会自动为现有用户生成默认账号和密码：
- 账号格式：C + 用户ID（6位补零）
- 默认密码：123456

### 2. 启动应用程序

```bash
mvn spring-boot:run
```

应用程序将在 http://localhost:8081 启动

## API测试

### 1. 获取验证码

**请求：**
```bash
GET http://localhost:8081/api/captcha
```

**响应示例：**
```json
{
  "code": 200,
  "message": "操作成功",
  "data": {
    "captchaToken": "b6f71eaf-313d-45c3-9296-61f1fd1d832c",
    "captchaImage": "data:image/png;base64,iVBORw0KGgo..."
  }
}
```

**说明：**
- `captchaToken`: 验证码令牌，登录时需要使用
- `captchaImage`: Base64编码的验证码图片，可以直接在HTML中显示
- 验证码有效期：5分钟
- 验证码为4位数字或字母，不区分大小写

### 2. 用户注册

**请求：**
```bash
POST http://localhost:8081/api/register
Content-Type: application/json

{
  "account": "C123456",
  "userName": "测试用户",
  "phone": "13800138000",
  "email": "test@example.com",
  "password": "password123",
  "address": "北京市朝阳区"
}
```

**响应示例（成功）：**
```json
{
  "code": 200,
  "message": "操作成功",
  "data": {
    "id": 1,
    "account": "C123456",
    "userName": "测试用户",
    "phone": "13800138000",
    "email": "test@example.com",
    "createTime": "2025-12-18T17:30:00"
  }
}
```

**错误码：**
- 11: 账号已存在
- 12: 手机号已被注册
- 13: 邮箱已被注册
- 400: 参数验证失败

**字段验证规则：**
- `account`: 必填，格式为首字符C + 5-15位数字/字母
- `userName`: 必填
- `phone`: 必填，11位手机号，以1开头
- `email`: 可选，邮箱格式
- `password`: 必填，6-20位
- `address`: 可选

### 3. 用户登录

**请求：**
```bash
POST http://localhost:8081/api/login
Content-Type: application/json

{
  "account": "C123456",
  "password": "password123",
  "captchaToken": "b6f71eaf-313d-45c3-9296-61f1fd1d832c",
  "captchaCode": "AB12"
}
```

**响应示例（成功）：**
```json
{
  "code": 200,
  "message": "操作成功",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiJ9.eyJ1c2VybmFtZSI6IkMxMjM0NTYiLCJpc0FkbWluIjowLCJpYXQiOjE3MDMxNTI4MDAsImV4cCI6MTcwMzc1NzYwMH0.xxx"
  }
}
```

**错误码：**
- 4: 请先获取验证码
- 5: 验证码错误
- 7: 账号或密码错误
- 8: 用户账户已被封禁

**说明：**
- 登录成功后返回JWT令牌
- 令牌有效期：7天
- 令牌包含用户名和管理员标识信息

## 使用Postman测试

### 1. 导入以下请求集合

创建一个新的Collection，添加以下请求：

#### 请求1：获取验证码
- Method: GET
- URL: http://localhost:8081/api/captcha
- 保存响应中的 `captchaToken` 和 `captchaImage`

#### 请求2：用户注册
- Method: POST
- URL: http://localhost:8081/api/register
- Headers: Content-Type: application/json
- Body (raw JSON):
```json
{
  "account": "C999999",
  "userName": "Postman Test User",
  "phone": "13900139000",
  "email": "postman@test.com",
  "password": "test123456",
  "address": "Test Address"
}
```

#### 请求3：用户登录
- Method: POST
- URL: http://localhost:8081/api/login
- Headers: Content-Type: application/json
- Body (raw JSON):
```json
{
  "account": "C999999",
  "password": "test123456",
  "captchaToken": "{{从请求1获取}}",
  "captchaCode": "{{查看验证码图片输入}}"
}
```

## 使用curl测试

### 完整测试流程

```bash
# 1. 获取验证码
curl -X GET http://localhost:8081/api/captcha

# 2. 注册用户
curl -X POST http://localhost:8081/api/register \
  -H "Content-Type: application/json" \
  -d '{
    "account": "C888888",
    "userName": "Curl Test User",
    "phone": "13800138888",
    "email": "curl@test.com",
    "password": "curl123456",
    "address": "Curl Test Address"
  }'

# 3. 登录（需要先获取验证码）
curl -X POST http://localhost:8081/api/login \
  -H "Content-Type: application/json" \
  -d '{
    "account": "C888888",
    "password": "curl123456",
    "captchaToken": "替换为实际的验证码令牌",
    "captchaCode": "替换为实际的验证码"
  }'
```

## Swagger UI测试

访问 Swagger UI 界面进行可视化测试：

```
http://localhost:8081/doc.html
```

在Swagger UI中可以：
1. 查看所有API接口文档
2. 直接在线测试接口
3. 查看请求和响应示例

## 常见问题

### 1. 验证码验证失败
- 确保验证码在5分钟有效期内
- 验证码不区分大小写
- 每个验证码只能使用一次

### 2. 账号格式错误
- 账号必须以字母C开头
- 后面跟5-15位数字或字母
- 示例：C123456, CTest001

### 3. 手机号格式错误
- 必须是11位数字
- 必须以1开头
- 示例：13800138000

### 4. 数据库连接失败
- 检查 application.yml 中的数据库配置
- 确保MySQL服务正在运行
- 确保数据库 pet_service_management 已创建

### 5. 编译错误
- 确保已安装Java 17
- 确保已安装Maven
- 执行 `mvn clean compile` 重新编译

## 功能验证清单

- [ ] 验证码生成成功
- [ ] 验证码图片可以正常显示
- [ ] 用户注册成功
- [ ] 账号重复检查生效
- [ ] 手机号重复检查生效
- [ ] 邮箱重复检查生效
- [ ] 密码加密存储（数据库中看不到明文密码）
- [ ] 验证码验证成功
- [ ] 登录成功并返回JWT令牌
- [ ] 账号或密码错误时返回正确错误码
- [ ] 验证码错误时返回正确错误码
- [ ] JWT令牌包含正确的用户信息

## 安全注意事项

1. **生产环境配置：**
   - 修改 JWT 密钥（application.yml 中的 jwt.secret）
   - 使用更强的密钥（至少256位）
   - 考虑使用环境变量存储敏感配置

2. **密码安全：**
   - 系统使用BCrypt加密密码
   - 密码不会以明文形式存储或传输
   - 建议用户使用强密码

3. **验证码安全：**
   - 验证码5分钟后自动过期
   - 验证码使用后立即失效
   - 防止暴力破解

4. **JWT令牌：**
   - 令牌有效期7天
   - 令牌包含用户身份信息
   - 前端应安全存储令牌（如HttpOnly Cookie）
